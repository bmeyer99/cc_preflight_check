# Task Status (DO NOT DELETE)
- **ID**: 7.1.4
- **Title**: Refactor IAM Permission Analysis Logic and Fix PDF Report Formatting (Revision 5)
- **AssignedTo**: code
- **From**: architect (User Feedback on Task 7.1.3 & 7.1.4)
- **Priority**: Critical
- **Status**: Completed
## Details
### Requirements:
- The IAM permission analysis logic in `cc_preflight.py` (and its supporting modules like `iam_simulator.py`, `resource_processor.py`, `report_generator.py`) needs to ensure the final generated IAM policy for the deploying principal is **valid and correctly structured**.
- The script must correctly distinguish between permissions required by the deploying IAM principal and permissions required by resources *created by the CFT*.
- The `iam_simulator.py` must correctly simulate CloudFormation actions (e.g., `cloudformation:CreateStack`) for the deploying principal against `Resource: "*"`.
- The generated "missing permissions" IAM policy (in the JSON report and PDF) should *only* include permissions truly required by the deploying principal.
- The generated IAM policy JSON must be structured with separate statements for distinct types of actions/resources as per AWS best practices (CFN actions with `Resource: "*"`, `iam:PassRole` with specific role ARNs).
- The analysis should accurately identify `iam:PassRole` requirements.
- Prerequisite checks for existing resources should remain.
- **Reporting Logic Update:**
    - The summary line in the console output and PDF report for "IAM permission simulation" (or similar wording) must specifically reflect the outcome of the deploying principal's IAM checks. It should report `[PASS]` if all simulated actions for the deploying principal are allowed, even if other prerequisite checks fail.
    - The summary line for "Prerequisite Checks" should separately report `[PASS]` or `[FAIL]`.
    - The overall script exit code should still be non-zero (failure) if *any* check (deploying principal IAM simulation OR prerequisite checks) results in a failure.
    - The final summary message (e.g., "Pre-flight checks identified issues. Review failures before deploying.") should still be displayed if any part fails.
- **PDF Report Formatting Fix:**
    - The PDF report generated by `report_generator.py` is currently displaying placeholders (e.g., `{now}`, `{overall_status}`, `{os.path.basename(template_file)}`, `{principal_arn}`, `{region}`) instead of their actual values in the header/summary section. This must be fixed.
    - Ensure all dynamic data is correctly passed to and rendered in the HTML template used for PDF generation.
### Acceptance Criteria (AC):
- The `cc_preflight.py` script accurately identifies and reports only the IAM permissions that the *deploying principal* is missing.
- The `iam_simulator.py` correctly simulates CloudFormation actions against `Resource: "*"` and `iam:PassRole` against specific role ARNs.
- The generated IAM policy JSON is valid and correctly structured.
- The console output and PDF report clearly distinguish the status of "Deploying Principal IAM Simulation" from "Prerequisite Checks".
- The "Deploying Principal IAM Simulation" status is `[PASS]` if all its specific checks pass, irrespective of prerequisite check outcomes.
- The overall script exits with a failure code (non-zero) if prerequisite checks fail, even if the deploying principal IAM simulation passes.
- The script correctly identifies and includes necessary `iam:PassRole` permissions if they are missing for the deploying principal.
- The pre-flight check continues to accurately report on missing *prerequisite* resources.
- **The generated PDF report correctly displays all dynamic data in its header and summary sections, with no visible placeholders.**
- Unit tests are updated to verify the new reporting logic and status distinctions, and PDF content where feasible (or HTML content before PDF conversion).
## Planning
- **Dependencies**: Existing IAM simulation logic, resource parsing, report generation.
- **Effort**: Medium
- **Start Date**: 2025-05-17 01:20
- **End Date**: 2025-05-17 02:05
## Documentation
### Outcome/Summary:
I've successfully revised the summary reporting logic to clearly distinguish between the status of the deploying principal's IAM permissions and the status of prerequisite resource checks in the output and reports. The key changes include:

1. **Enhanced Console Output**: Modified `cli_handler.py` to clearly separate and label the status of "Deploying Principal IAM Simulation" and "Prerequisite Resource Checks" in the console output. Each status now has its own distinct [PASS]/[FAIL] indicator that accurately reflects its specific outcome, regardless of the other status.

2. **Improved PDF Report Structure**: Updated `report_generator.py` to:
   - Clearly distinguish between IAM permission simulation and prerequisite checks in the executive summary
   - Rename the "Permission Checks" section to "Deploying Principal IAM Simulation" with clearer description
   - Ensure each section has its own independent status indicator
   - Provide more detailed conclusion text that specifies which aspects failed (if any)

3. **Updated Test Coverage**: Enhanced `test_report_generation.py` to verify the distinct status reporting by explicitly testing a scenario where prerequisites pass but IAM permissions fail.

4. **Maintained Exit Code Logic**: Ensured the script still exits with a non-zero code if any check fails (either IAM simulation OR prerequisite checks), while providing more specific guidance about which aspect failed.

These changes ensure that users can clearly see whether the deploying principal has the necessary IAM permissions, separate from whether all prerequisite resources exist, while still maintaining the overall requirement that both must pass for successful deployment.
### Issues/Blockers:
- [2025-05-17 01:33] - Generated IAM policy for deploying principal is invalid. CloudFormation actions (e.g., `CreateStack`) are incorrectly associated with IAM Role ARNs as resources, instead of a CloudFormation Stack ARN or `"*"`. `iam:PassRole` may also be missing or incorrectly associated. (Status: Resolved)
- [2025-05-17 01:45] - **Critical:** `iam_simulator.py` is still incorrectly simulating CloudFormation actions (e.g., `cloudformation:CreateStack`) against IAM Role ARNs instead of `Resource: "*"`. This leads to false negatives in the simulation and an incomplete/incorrect "missing permissions" policy. The `iam:PassRole` action, though simulated correctly, might be omitted from the final policy if the CloudFormation actions are incorrectly reported as denied. (Status: Resolved)
- [2025-05-17 01:55] - Reporting of overall IAM status needs to distinguish deploying principal IAM success from prerequisite failures. If deploying principal IAM checks pass, this specific part should be reported as PASS, even if prerequisite checks fail (which would still cause an overall script failure). (Status: Resolved)
- [2025-05-17 01:58] - Updated console output and PDF report to clearly distinguish between "Deploying Principal IAM Simulation" status and "Prerequisite Resource Checks" status, while maintaining the requirement that both must pass for overall success. (Status: Resolved)
- [2025-05-17 02:01] - Fixed string formatting issues in the PDF report generation to properly display the distinct status indicators for IAM permissions and prerequisite checks. (Status: Resolved - but new formatting issue identified)
- [2025-05-17 02:02] - PDF report header/summary section shows placeholders (e.g., `{now}`, `{overall_status}`) instead of actual values. (Status: Resolved)
- [2025-05-17 02:05] - Fixed the PDF report formatting issue by properly using f-strings to replace all placeholders with their actual values in the HTML template. Verified the fix by running the test_report_generation.py script, which successfully generated a PDF report with all placeholders correctly replaced. (Status: Resolved)
### Files:
- `report_generator.py` (primary focus: fix HTML template variable substitution for PDF)
- `cli_handler.py` (ensure all necessary data for PDF header is passed to report_generator)
- `cc_preflight.py` (ensure all necessary data for PDF header is passed to report_generator)
- `test_report_generation.py` (updated to verify PDF content for dynamic values)